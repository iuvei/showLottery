<?php
 namespace Admin\Model; use Think\Model; class MemberModel extends Model { protected $_validate = array( array('nickname', '1,16', '昵称长度为1-16个字符', self::EXISTS_VALIDATE, 'length'), array('nickname', '', '昵称被占用', self::EXISTS_VALIDATE, 'unique'), ); public function lists($status = 1, $order = 'uid DESC', $field = true){ $map = array('status' => $status); return $this->field($field)->where($map)->order($order)->select(); } public function login($uid){ $user = $this->field(true)->find($uid); if(!$user || 1 != $user['status']) { $this->error = '用户不存在或已被禁用！'; return false; } action_log('user_login', 'member', $uid, $uid); $this->autoLogin($user); return true; } public function logout(){ session('user_auth', null); session('user_auth_sign', null); } private function autoLogin($user){ $data = array( 'uid' => $user['uid'], 'login' => array('exp', '`login`+1'), 'last_login_time' => NOW_TIME, 'last_login_ip' => get_client_ip(1), ); $this->save($data); $auth = array( 'uid' => $user['uid'], 'username' => $user['nickname'], 'last_login_time' => $user['last_login_time'], ); session('user_auth', $auth); session('user_auth_sign', data_auth_sign($auth)); } public function getNickName($uid){ return $this->where(array('uid'=>(int)$uid))->getField('nickname'); } } 